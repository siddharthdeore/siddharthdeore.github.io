<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patante Teoria</title>

<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- Animate.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

<!-- SweetAlert2 -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
  :root{
    --bg-start: #e9f7ff;
    --bg-end: #fbfdff;
    --accent: #60a5fa;
    --accent-2: #7c3aed;
    --card-bg: #ffffff;
    --muted: #6b7280;
    --glass: rgba(255,255,255,0.85);
  }
  [data-theme="dark"]{
    --bg-start:#0b1220; --bg-end:#071023; --card-bg:#071126; --muted:#94a3b8; --glass: rgba(6,8,20,0.7);
  }

  html,body{height:100%;}
  body{
    margin:0;
    min-height:100%;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    background: linear-gradient(160deg, var(--bg-start) 0%, var(--bg-end) 100%);
    padding:1rem;
    transition: background .25s ease, color .25s ease;
  }

  .app-wrap{max-width:1100px;margin:0 auto;position:relative;}
  .card-soft{
    background:var(--card-bg);
    border:0;
    border-radius:1rem;
    box-shadow:0 8px 30px rgba(15,23,42,0.06);
  }

  /* Header */
  .app-head{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand {display:flex;gap:.75rem;align-items:center}
  .brand .logo{
    width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem;
    box-shadow:0 8px 24px rgba(96,165,250,0.12);
  }
  .muted {color:var(--muted)}
  .controls-grid .form-select, .controls-grid .form-check {min-width:100px}

  /* question card specifics */
  .question-card {min-height:420px;display:flex;flex-direction:column;padding:1.25rem;gap:1rem;overflow:hidden}
  .q-meta{display:flex;align-items:center;justify-content:space-between;gap:1rem}
  .q-text{font-size:1.15rem;font-weight:600;color:var(--text-color);line-height:1.45;word-wrap:break-word}
  .q-image{width:100%;height:auto;max-height:320px;border-radius:.75rem;box-shadow:0 8px 30px rgba(37,99,235,0.06);object-fit:contain;display:block}
  .hint-box,.translation-box{border-radius:.5rem;padding:.75rem;background:#fff7ed;border-left:4px solid #f59e0b;color:#92400e}
  .translation-box{background:#eef2ff;border-left-color:#60a5fa;color:#1e3a8a}

  .btn-answer{padding:.85rem 1rem;border-radius:.75rem;font-weight:700}
  .btn-true{background:linear-gradient(90deg,#22c55e,#10b981);color:#fff;border:0}
  .btn-false{background:linear-gradient(90deg,#ef4444,#dc2626);color:#fff;border:0}

  .progress {height:10px;border-radius:999px;overflow:hidden}
  .progress .progress-bar{background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .45s ease}

  /* PRNG control small */
  .prng-control input {width:120px}

  /* dropdown menu (top-right) */
  .top-right-menu{position:fixed;right:12px;top:12px;z-index:1300}

  /* Loading overlay */
  .loading-overlay{
    position:fixed;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.85));
    display:flex;align-items:center;justify-content:center;z-index:1400;backdrop-filter: blur(6px);
  }
  [data-theme="dark"] .loading-overlay{background:linear-gradient(180deg, rgba(2,6,23,0.85), rgba(3,10,24,0.9));}

  /* collapsed state */
  .collapsed .header-area{display:none}
  .collapsed .stats-area{display:none}
  .collapsed .top-padding{padding-top:0}

  /* mobile fixes */
  @media (max-width:768px){
    .controls-grid{width:100%}
    .app-head{align-items:flex-start}
    .prng-control input {width:100px}
    .question-card{min-height:360px;padding:.9rem}
    .q-image{max-height:220px}
  }
</style>
</head>
<body>

<div class="top-right-menu">
  <div class="dropdown">
    <button class="btn btn-sm btn-light shadow-sm" id="menuToggle" data-bs-toggle="dropdown" aria-expanded="false" title="Menu">
      <i class="bi bi-three-dots-vertical"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li><button class="dropdown-item" id="toggleControlsBtn"><i class="bi bi-layout-three-columns"></i> Show/Hide Controls</button></li>
      <li><button class="dropdown-item" id="resetSeedMenu"><i class="bi bi-arrow-counterclockwise"></i> Reset Seed</button></li>
      <li><button class="dropdown-item" id="restartQuizMenu"><i class="bi bi-arrow-repeat"></i> Restart Quiz</button></li>
      <li><hr class="dropdown-divider"></li>
      <li><button class="dropdown-item" id="toggleThemeBtn"><i class="bi bi-circle-half"></i> Toggle Dark Mode</button></li>
    </ul>
  </div>
</div>

<div class="app-wrap top-padding" id="appWrap" data-theme="light">
  <!-- HEADER (collapsible) -->
  <div class="card card-soft p-3 mb-4 header-area" id="headerArea">
    <div class="app-head">
      <div class="brand">
        <div class="logo"><i class="bi bi-lightning-charge-fill"></i></div>
        <div>
          <div class="h5 mb-0">Quiz Trainer Pro</div>
          <small class="muted">Playful ‚Ä¢ Focused ‚Ä¢ Fast</small>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center flex-wrap controls-grid">
        <select id="subjectSelect" class="form-select form-select-sm" aria-label="Subject"></select>
        <select id="lessonSelect" class="form-select form-select-sm" aria-label="Lesson"></select>

        <div class="btn-group" role="group" aria-label="Modes">
          <button class="btn btn-sm btn-outline-primary" data-mode="practice" title="Practice mode">
            <i class="bi bi-bullseye"></i> <span class="d-none d-md-inline ms-1">Practice</span>
          </button>
          <button class="btn btn-sm btn-outline-success" data-mode="learning" title="Learning mode">
            <i class="bi bi-book"></i> <span class="d-none d-md-inline ms-1">Learning</span>
          </button>
          <button class="btn btn-sm btn-outline-warning" data-mode="mock" title="Mock test">
            <i class="bi bi-pencil-square"></i> <span class="d-none d-md-inline ms-1">Mock</span>
          </button>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between mt-3 stats-area flex-wrap controls-grid">
      <div class="d-flex gap-3 align-items-center flex-wrap controls-grid">
        <div class="d-flex align-items-center gap-2">
          <small class="muted">Auto-show hints</small>
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" id="autoShowHint" type="checkbox">
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <small class="muted">Sound effects</small>
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" id="soundEffects" type="checkbox" checked>
          </div>
        </div>

        <!-- PRNG UI -->
        <div class="d-flex align-items-center gap-2 pr-2 prng-control flex-wrap controls-grid">
          <small class="muted">Seed</small>
          <input type="number" id="prngSeed" class="form-control form-control-sm" placeholder="seed" />
          <button class="btn btn-sm btn-outline-secondary" id="setSeedBtn" title="Set seed">Set</button>
          <button class="btn btn-sm btn-outline-secondary" id="resetSeedBtn" title="Reset seed"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
      </div>

      <div class="d-flex gap-3 align-items-center">
        <div class="text-end">
          <div class="muted small">Mode</div>
          <div id="currentModeLabel" class="fw-bold">‚Äî</div>
        </div>

        <div class="text-end" id="timerDisplay" style="display:none;">
          <div class="muted small">Time</div>
          <div id="timerValue" class="fw-bold">20:00</div>
        </div>

        <div class="text-end">
          <div class="muted small">Progress</div>
          <div id="progressValue" class="fw-bold">0/0</div>
        </div>

        <div class="text-end">
          <div class="muted small">Score</div>
          <div id="scoreValue" class="fw-bold">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUESTION CARD -->
  <div class="card card-soft question-card p-3" id="questionCard">
    <div id="questionContent" class="w-100">
      <div class="text-center py-4">
        <i class="bi bi-joystick" style="font-size:48px;color:#bfdbfe"></i>
        <h5 class="mt-3">Select a mode to start</h5>
        <p class="muted">Practice, learn, or attempt a timed mock test.</p>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay" aria-hidden="false">
  <div class="text-center">
    <div class="logo mb-3" style="width:72px;height:72px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;
         background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;font-size:22px;box-shadow:0 12px 40px rgba(96,165,250,0.14);">
      <i class="bi bi-lightning-charge-fill"></i>
    </div>
    <div class="mt-2 mb-3">
      <div class="spinner-border text-primary" role="status" style="width:48px;height:48px;">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="h6 mb-1">Preparing your quiz‚Ä¶</div>
    <div class="muted small">Loading questions and assets</div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* Final polished app JS
   - Responsive fixes for mobile (no overflow)
   - Full-screen loading overlay while fetching quiz JSON
   - Top-right dropdown menu (show/hide, reset seed, restart, toggle dark)
   - External audio playback for correct/wrong answers
   - PRNG seed UI, TTS, translations (mymemory), and preserved core logic
*/

/* Fixed external sound URLs */
const SOUND_SUCCESS = 'https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg';
const SOUND_ERROR   = 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg';

/* PRNG implementation */
class PRNG {
  constructor(seed=42){ this.set(seed); }
  set(seed){ this.seed = (Number(seed) || 42) % 2147483647; if(this.seed<=0) this.seed+=2147483646; }
  next(){ return this.seed = this.seed * 16807 % 2147483647; }
  nextFloat(){ return (this.next() - 1) / 2147483646; }
}
const prng = new PRNG(42);

/* App state */
const State = {
  data:{}, allQuestions:[], cache:{subjects:[], lessons:{}},
  session:{ mode:null, questions:[], currentIndex:0, score:0, timer:null, timeLeft:0 },
  settings:{ autoShowHint:false, soundEffects:true }
};
const Config = { MOCK_QUESTIONS:30, MOCK_TIME:20*60, API_ENDPOINT:'./quiz_en.json' };

/* Helpers */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
const make = (html)=> { const t=document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; };
const escapeHtml = s => String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]) );

/* Preload audio */
const audioSuccess = new Audio(SOUND_SUCCESS); audioSuccess.preload='auto';
const audioError = new Audio(SOUND_ERROR); audioError.preload='auto';

/* Data manager */
const DataManager = {
  async load(){
    try{
      const res = await fetch(Config.API_ENDPOINT, {cache:'no-store'});
      State.data = await res.json();
      this.flatten(); this.cacheStructure(); UI.populateSubjects();
      return true;
    } catch(e){
      UI.error('Failed to load quiz data'); console.error(e); return false;
    }
  },
  flatten(){
    State.allQuestions = [];
    for(const [subject, lessons] of Object.entries(State.data || {})){
      for(const [lesson, questions] of Object.entries(lessons || {})){
        for(const q of questions || []){
          State.allQuestions.push({
            subject, lesson,
            text: q.q || '',
            answer: !!q.a,
            image: q.img || null,
            hint: q['q-en'] || ''
          });
        }
      }
    }
  },
  cacheStructure(){
    State.cache.subjects = Object.keys(State.data || {});
    State.cache.subjects.forEach(s => State.cache.lessons[s] = Object.keys(State.data[s] || {}));
  },
  getQuestions(subject=null, lesson=null){
    if(!subject) return [...State.allQuestions];
    if(!lesson) return State.allQuestions.filter(q => q.subject === subject);
    return State.allQuestions.filter(q => q.subject === subject && q.lesson === lesson);
  }
};

/* Session logic */
const Session = {
  start(mode, subject=null, lesson=null){
    this.reset();
    let qs = DataManager.getQuestions(subject, lesson);
    if(!qs.length){ UI.error('No questions for selected filters'); return false; }
    State.session.mode = mode;
    State.session.questions = this.shuffle(qs);
    if(mode === 'mock'){ State.session.questions = State.session.questions.slice(0, Config.MOCK_QUESTIONS); this.startTimer(Config.MOCK_TIME); }
    State.session.currentIndex = 0; State.session.score = 0; UI.renderQuestion();
    return true;
  },
  reset(){
    this.stopTimer(); State.session = { mode:null, questions:[], currentIndex:0, score:0, timer:null, timeLeft:0 }; UI.updateStats();
  },
  shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){ const j = Math.floor(prng.nextFloat() * (i+1)); [a[i], a[j]] = [a[j], a[i]]; }
    return a;
  },
  current(){ return State.session.questions[State.session.currentIndex] || null; },
  next(){ State.session.currentIndex++; if(this.isComplete()) UI.showResults(false); else UI.renderQuestion(); },
  answer(userAnswer){
    const q = this.current(); if(!q) return null;
    const correct = q.answer === userAnswer; if(correct) State.session.score++;
    return { correct, correctAnswer: q.answer };
  },
  isComplete(){ return State.session.currentIndex >= State.session.questions.length; },
  startTimer(seconds){
    State.session.timeLeft = seconds; this.updateTimer(); State.session.timer = setInterval(()=>{ State.session.timeLeft--; this.updateTimer(); if(State.session.timeLeft<=0){ this.stopTimer(); UI.showResults(true); } }, 1000);
  },
  stopTimer(){ if(State.session.timer){ clearInterval(State.session.timer); State.session.timer = null; } },
  updateTimer(){ const t = State.session.timeLeft; const m = Math.floor(t/60), s = t%60; $('#timerValue').textContent = `${m}:${String(s).padStart(2,'0')}`; $('#timerDisplay').style.display = (State.session.mode === 'mock') ? 'block' : 'none'; }
};

/* UI */
const UI = {
  error(msg){ Swal.fire({icon:'error',title:'Error',text:msg}); },
  toast(msg){ Swal.fire({toast:true,position:'top-end',showConfirmButton:false,timer:1100,icon:'info',title:msg}); },

  populateSubjects(){
    const sel = $('#subjectSelect'); sel.innerHTML = '<option value="">All Subjects</option>';
    for(const s of State.cache.subjects){
      const count = DataManager.getQuestions(s).length;
      sel.appendChild(make(`<option value="${escapeHtml(s)}">${escapeHtml(s)} (${count})</option>`));
    }
    sel.addEventListener('change', ()=> UI.populateLessons(sel.value));
  },
  populateLessons(subject){
    const sel = $('#lessonSelect'); sel.innerHTML = '<option value="">All Lessons</option>';
    if(!subject) return;
    for(const l of State.cache.lessons[subject] || []){
      const count = DataManager.getQuestions(subject, l).length;
      sel.appendChild(make(`<option value="${escapeHtml(l)}">${escapeHtml(l)} (${count})</option>`));
    }
  },

  renderQuestion(){
    const q = Session.current();
    if(!q){ this.showResults(false); return; }

    const idx = State.session.currentIndex + 1; const total = State.session.questions.length;
    $('#progressValue').textContent = `${idx}/${total}`; $('#scoreValue').textContent = State.session.score;
    $('#currentModeLabel').textContent = this.modeLabel(State.session.mode || '‚Äî');

    const left = `
      <div class="q-meta mb-2">
        <div class="muted small text-truncate" style="max-width:60%">${escapeHtml(q.subject)} ‚Ä∫ ${escapeHtml(q.lesson)}</div>
        <div class="badge bg-light text-dark">Q ${idx} / ${total}</div>
      </div>
      <div class="q-text mb-3">${escapeHtml(q.text)}</div>
    `;

    const imgHtml = q.image ? `<div class="mb-2"><img src="${escapeHtml(q.image)}" alt="question image" class="q-image img-fluid" loading="lazy" /></div>` : '';

    const hintHtml = (State.settings.autoShowHint && q.hint) ? `<div class="hint-box mb-2">üí° ${escapeHtml(q.hint)}</div>` : '';

    const actions = `
      <div class="d-flex gap-2 flex-wrap mt-2">
        ${!State.settings.autoShowHint && q.hint ? `<button class="btn btn-sm btn-outline-secondary" data-act="show-hint"> <i class="bi bi-lightbulb"></i> Hint </button>` : ''}
        <button class="btn btn-sm btn-outline-primary" data-act="translate"><i class="bi bi-globe"></i> Translate</button>
        <button class="btn btn-sm btn-outline-info" data-act="speak"><i class="bi bi-volume-up"></i> Speak</button>
        ${State.session.mode === 'practice' ? `<button class="btn btn-sm btn-outline-dark" data-act="skip">Skip</button>` : ''}
      </div>
    `;

    const answers = `
      <div class="d-grid gap-2 mt-3" style="grid-template-columns:repeat(2,1fr);">
        <button class="btn btn-answer btn-true" data-answer="true"><i class="bi bi-check-lg"></i> True</button>
        <button class="btn btn-answer btn-false" data-answer="false"><i class="bi bi-x-lg"></i> False</button>
      </div>
    `;

    const progressPct = Math.round((idx/total)*100);

    // Layout: left content and right column with image + progress; on mobile it stacks naturally
    const right = `
      <div class="d-flex flex-column align-items-stretch">
        ${imgHtml}
        <div class="mt-3">
          <div class="progress"><div class="progress-bar" style="width:${progressPct}%"></div></div>
          <div class="d-flex justify-content-between mt-2 muted small"><div>Progress</div><div>${progressPct}%</div></div>
        </div>
      </div>
    `;

    $('#questionContent').innerHTML = `<div class="d-flex flex-column flex-md-row gap-3">${'<div class="flex-grow-1">'+left+hintHtml+actions+answers+'</div>'}<div style="min-width:220px;max-width:360px">${right}</div></div>`;

    // fix: ensure images fit on mobile (object-fit used in CSS) and no overflow
    UI.bindQuestionActions();
  },

  bindQuestionActions(){
    const container = $('#questionContent');
    container.onclick = async (ev) => {
      const btn = ev.target.closest('button');
      if(!btn) return;
      const act = btn.getAttribute('data-act');
      const ans = btn.getAttribute('data-answer');

      if(ans !== null){
        const userAnswer = ans === 'true';
        const result = Session.answer(userAnswer);
        if(State.settings.soundEffects){
          try { if(result.correct){ audioSuccess.currentTime=0; audioSuccess.play().catch(()=>{}); } else { audioError.currentTime=0; audioError.play().catch(()=>{}); } } catch(e){}
        }
        UI.provideFeedback(result.correct, result.correctAnswer);
      } else if(act === 'skip'){
        Session.next();
      } else if(act === 'show-hint'){
        const q = Session.current(); if(!q) return;
        btn.remove();
        const hintBox = make(`<div class="hint-box mb-2">üí° ${escapeHtml(q.hint)}</div>`);
        container.querySelector('.q-text').after(hintBox);
      } else if(act === 'translate'){
        UI.translateCurrent(btn);
      } else if(act === 'speak'){
        UI.speakCurrent();
      }
    };
  },

  provideFeedback(correct, correctAnswer){
    $$('.btn-answer').forEach(b=>{ b.disabled=true; b.classList.add('opacity-75'); });
    if(correct){
      Swal.fire({icon:'success',title:'Correct',showConfirmButton:false,timer:800,background:'#ecfdf5'});
    } else {
      Swal.fire({icon:'error',title:'Wrong',html:`Correct: <strong>${correctAnswer?'True':'False'}</strong>`,showConfirmButton:false,timer:1100,background:'#fff1f2'});
    }
    $('#scoreValue').textContent = State.session.score;
    const q = Session.current();
    if(State.session.mode === 'learning' && !correct) State.session.questions.push(q);
    setTimeout(()=>{ Session.next(); }, (State.session.mode === 'learning' && !correct) ? 1100 : 700);
  },

  showResults(timeExpired=false){
    Session.stopTimer();
    const s = State.session;
    if(!s.questions.length){ $('#questionContent').innerHTML = `<div class="text-center py-4"><p class="muted">No questions</p></div>`; return; }
    const percent = Math.round((s.score / s.questions.length) * 100);
    let title = 'Result'; if(timeExpired) title="Time's up"; else if(percent>=90) title='Excellent!'; else if(percent>=70) title='Great'; else if(percent>=50) title='Keep practicing'; else title="Don't give up";

    $('#questionContent').innerHTML = `<div class="text-center py-3"><div class="h4 mb-1">${escapeHtml(title)}</div><div class="display-6 fw-bold">${s.score} / ${s.questions.length}</div><div class="muted mb-3">${percent}%</div><div class="d-flex gap-2 justify-content-center"><button class="btn btn-primary" id="tryAgain">Try Again</button><button class="btn btn-outline-secondary" id="backHome">Home</button></div></div>`;
    $('#tryAgain').onclick = ()=> { Session.start(s.mode, $('#subjectSelect').value || null, $('#lessonSelect').value || null); };
    $('#backHome').onclick = ()=> { Session.reset(); $('#questionContent').innerHTML = `<div class="text-center py-4"><i class="bi bi-joystick" style="font-size:48px;color:#bfdbfe"></i><h5 class="mt-3">Select a mode to start</h5><p class="muted">Practice, learn, or attempt a timed mock test.</p></div>`; };
  },

  updateStats(){ $('#progressValue').textContent = `${State.session.currentIndex}/${Math.max(1, State.session.questions.length)}`; $('#scoreValue').textContent = State.session.score; $('#currentModeLabel').textContent = this.modeLabel(State.session.mode || '‚Äî'); },

  modeLabel(m){ const map = { practice:'Practice', learning:'Learning', mock:'Mock Test' }; return map[m]||'‚Äî'; },

  async translateCurrent(btn){
    const q = Session.current(); if(!q) return;
    btn.disabled = true; btn.textContent = 'Translating...';
    try {
      const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q.text)}&langpair=it|en`);
      const data = await res.json();
      const text = data?.responseData?.translatedText || 'Translation not available';
      const box = make(`<div class="translation-box mt-2">üåê ${escapeHtml(text)}</div>`);
      btn.parentNode.after(box);
      btn.remove();
    } catch(e){ btn.disabled=false; btn.textContent='Translate'; UI.toast('Translation failed'); console.error(e); }
  },

  speakCurrent(){
    const q = Session.current(); if(!q) return;
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance(q.text); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);
    } else { UI.toast('TTS not available'); }
  }
};

/* Event wiring */
document.addEventListener('click', (e)=>{
  const modeBtn = e.target.closest('[data-mode]');
  if(modeBtn){
    const mode = modeBtn.getAttribute('data-mode');
    const subject = $('#subjectSelect').value || null;
    const lesson = $('#lessonSelect').value || null;
    if(Session.start(mode, subject, lesson)){ $('#currentModeLabel').textContent = UI.modeLabel(mode); tryUnlockAudio(); }
  }
});

/* settings toggles */
$('#autoShowHint').addEventListener('change', e => State.settings.autoShowHint = e.target.checked);
$('#soundEffects').addEventListener('change', e => State.settings.soundEffects = e.target.checked);

/* PRNG controls */
$('#setSeedBtn').addEventListener('click', ()=>{
  const v = Number($('#prngSeed').value);
  if(Number.isNaN(v)){ UI.toast('Enter a valid number'); return; }
  prng.set(v); UI.toast('Seed applied');
});
$('#resetSeedBtn').addEventListener('click', ()=>{ prng.set(42); $('#prngSeed').value=''; UI.toast('Seed reset'); });

/* Menu actions (dropdown) */
$('#toggleControlsBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('collapsed'); // hides header & stats
});
$('#resetSeedMenu').addEventListener('click', ()=>{ prng.set(42); $('#prngSeed').value=''; UI.toast('Seed reset'); });
$('#restartQuizMenu').addEventListener('click', ()=>{ const m = State.session.mode; if(m) Session.start(m, $('#subjectSelect').value||null, $('#lessonSelect').value||null); else location.reload(); });
$('#toggleThemeBtn').addEventListener('click', ()=>{
  const app = $('#appWrap'); const current = app.getAttribute('data-theme') || 'light';
  app.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
});

/* Keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(!State.session.questions.length) return;
  if(e.key === 'ArrowRight'){ Session.next(); }
  if(e.key.toLowerCase() === 't'){ const r = Session.answer(true); if(r){ if(State.settings.soundEffects){ audioSuccess.currentTime=0; audioSuccess.play().catch(()=>{}); } UI.provideFeedback(r.correct, r.correctAnswer); } }
  if(e.key.toLowerCase() === 'f'){ const r = Session.answer(false); if(r){ if(State.settings.soundEffects){ audioError.currentTime=0; audioError.play().catch(()=>{}); } UI.provideFeedback(r.correct, r.correctAnswer); } }
});

/* Ensure audio allowed by user gesture - no autoplay */
function tryUnlockAudio(){ /* audio playback is initiated by user actions (answers) ‚Äî no-op */ }

/* Loading overlay control */
function showLoading(show = true){
  const overlay = $('#loadingOverlay');
  overlay.style.display = show ? 'flex' : 'none';
}

/* Init */
(async function init(){
  showLoading(true);
  await DataManager.load();
  // entrance animation
  document.querySelectorAll('.card-soft').forEach((c,i)=> c.classList.add('animate__animated','animate__fadeInUp'));
  // small delay for smooth fade
  setTimeout(()=> showLoading(false), 350);
})();
</script>
</body>
</html>
